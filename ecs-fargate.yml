AWSTemplateFormatVersion: '2010-09-09'
Description: ECS Fargate (ALB) para api-students (Flask/SQLite, port 8000)

Parameters:
  VpcId: { Type: AWS::EC2::VPC::Id }
  SubnetIds: { Type: List<AWS::EC2::Subnet::Id> }
  ImageUri: { Type: String }
  LabRoleArn: { Type: String }
  DesiredCount: { Type: Number, Default: 1 }
  ContainerPort: { Type: Number, Default: 8000 }

Resources:
  ALBSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG ALB
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: 80, ToPort: 80, CidrIp: 0.0.0.0/0 }

  ServiceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG Service
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - { IpProtocol: tcp, FromPort: !Ref ContainerPort, ToPort: !Ref ContainerPort, SourceSecurityGroupId: !Ref ALBSG }

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      Subnets: !Ref SubnetIds
      SecurityGroups: [!Ref ALBSG]
      Type: application

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Port: !Ref ContainerPort
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VpcId
      HealthCheckPath: /
      Matcher: { HttpCode: 200-399 }

  Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - { Type: forward, TargetGroupArn: !Ref TargetGroup }

  Cluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: api-students-cluster

  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      RequiresCompatibilities: [FARGATE]
      Cpu: '256'
      Memory: '512'
      NetworkMode: awsvpc
      ExecutionRoleArn: !Ref LabRoleArn
      TaskRoleArn: !Ref LabRoleArn
      ContainerDefinitions:
        - Name: api-students
          Image: !Ref ImageUri
          PortMappings: [ { ContainerPort: !Ref ContainerPort } ]
          Essential: true

  Service:
    Type: AWS::ECS::Service
    DependsOn: Listener
    Properties:
      Cluster: !Ref Cluster
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          Subnets: !Ref SubnetIds
          SecurityGroups: [!Ref ServiceSG]
      LoadBalancers:
        - TargetGroupArn: !Ref TargetGroup
          ContainerName: api-students
          ContainerPort: !Ref ContainerPort
      TaskDefinition: !Ref TaskDefinition

Outputs:
  ALBDNSName:
    Value: !GetAtt ALB.DNSName
    Description: DNS p√∫blico del ALB
